<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
    <meta name="theme-color" content="#0a0a0a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Quran Search</title>
    <link rel="icon" type="image/png" href="favicon-32x32.png" sizes="32x32">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #141414;
            --bg-tertiary: #1e1e1e;
            --bg-elevated: #282828;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --text-tertiary: #606060;
            --accent: #3b82f6;
            --accent-hover: #2563eb;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --border: #2a2a2a;
            --overlay: rgba(0, 0, 0, 0.9);
            --overlay-light: rgba(0, 0, 0, 0.6);
            --highlight-bg: #f59e0b;
            --highlight-text: #000000;
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
            --safe-left: env(safe-area-inset-left, 0px);
            --safe-right: env(safe-area-inset-right, 0px);
            --header-height: 56px;
            --player-height: 72px;
            --transition-fast: 150ms ease;
            --transition-normal: 250ms ease;
            --transition-slow: 350ms cubic-bezier(0.4, 0, 0.2, 1);
        }

        .light-mode {
            --bg-primary: #f5f5f5;
            --bg-secondary: #ffffff;
            --bg-tertiary: #e5e5e5;
            --bg-elevated: #d4d4d4;
            --text-primary: #171717;
            --text-secondary: #525252;
            --text-tertiary: #a3a3a3;
            --border: #e5e5e5;
            --overlay: rgba(255, 255, 255, 0.9);
            --overlay-light: rgba(255, 255, 255, 0.6);
        }

        *, *::before, *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            height: 100%;
            overflow: hidden;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, system-ui, sans-serif;
            font-size: 15px;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        button {
            font: inherit;
            color: inherit;
            background: none;
            border: none;
            cursor: pointer;
            touch-action: manipulation;
        }

        input {
            font: inherit;
            color: inherit;
        }

        [hidden] { display: none !important; }

        .icon {
            width: 24px;
            height: 24px;
            fill: none;
            stroke: currentColor;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
            flex-shrink: 0;
        }
        .icon-sm { width: 20px; height: 20px; }
        .icon-lg { width: 28px; height: 28px; }

        #app {
            height: 100%;
            display: flex;
            flex-direction: column;
            padding-top: var(--safe-top);
            padding-left: var(--safe-left);
            padding-right: var(--safe-right);
        }

        .header {
            height: var(--header-height);
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            padding: 0 12px;
            gap: 8px;
            flex-shrink: 0;
            z-index: 50;
        }

        .header-title {
            flex: 1;
            font-size: 18px;
            font-weight: 600;
            text-align: center;
        }

        .header-subtitle {
            font-size: 11px;
            color: var(--text-secondary);
            font-weight: 400;
        }

        .header-btn {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background var(--transition-fast);
            color: var(--text-secondary);
        }
        .header-btn:hover { background: var(--bg-tertiary); }
        .header-btn:active { background: var(--bg-elevated); }

        .search-section {
            background: var(--bg-secondary);
            padding: 12px 16px 16px;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }

        .search-bar {
            display: flex;
            align-items: center;
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 0 12px;
            height: 48px;
            gap: 10px;
            transition: all var(--transition-fast);
        }

        .search-bar:focus-within {
            outline: 2px solid var(--accent);
            outline-offset: -2px;
        }

        .search-bar svg { color: var(--text-tertiary); flex-shrink: 0; }

        .search-input {
            flex: 1;
            background: none;
            border: none;
            outline: none;
            height: 100%;
            min-width: 0;
            text-align: right;
            direction: rtl;
            font-size: 16px;
        }
        .search-input::placeholder { color: var(--text-tertiary); }
        .search-input:disabled { opacity: 0.5; }

        .search-clear {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: var(--bg-elevated);
            color: var(--text-secondary);
            transition: all var(--transition-fast);
        }
        .search-clear:hover { background: var(--border); color: var(--text-primary); }

        .search-controls {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .search-btn {
            flex: 1;
            height: 44px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all var(--transition-fast);
        }

        .search-btn-primary {
            background: var(--accent);
            color: white;
        }
        .search-btn-primary:hover { background: var(--accent-hover); }
        .search-btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }

        .search-btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }
        .search-btn-secondary:hover { background: var(--bg-elevated); color: var(--text-primary); }
        .search-btn-secondary.active {
            background: var(--success);
            color: white;
        }

        .results-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }

        .results-count {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .results-count strong {
            color: var(--text-primary);
            font-weight: 600;
        }

        .copy-all-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: var(--success);
            color: white;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            transition: all var(--transition-fast);
        }
        .copy-all-btn:hover { opacity: 0.9; }

        .main-content {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            overscroll-behavior: contain;
            -webkit-overflow-scrolling: touch;
        }

        .status-message {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 48px 32px;
            text-align: center;
            min-height: 200px;
        }

        .status-icon {
            width: 56px;
            height: 56px;
            color: var(--text-tertiary);
            margin-bottom: 16px;
        }

        .status-title {
            font-size: 17px;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .status-text {
            color: var(--text-secondary);
            font-size: 14px;
            max-width: 280px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .results-list {
            padding: 8px;
        }

        .result-card {
            background: var(--bg-secondary);
            border-radius: 16px;
            margin-bottom: 10px;
            overflow: hidden;
            border: 1px solid var(--border);
        }

        .result-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 14px 16px 10px;
            gap: 12px;
        }

        .result-card-info {
            flex: 1;
            min-width: 0;
        }

        .result-card-title {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 2px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .result-card-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            background: var(--accent);
            color: white;
            border-radius: 50%;
            font-size: 12px;
            font-weight: 600;
            flex-shrink: 0;
        }

        .result-card-subtitle {
            color: var(--text-secondary);
            font-size: 13px;
        }

        .result-card-badge {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            white-space: nowrap;
        }

        .result-card-text {
            text-align: right;
            direction: rtl;
            font-size: 22px;
            line-height: 2;
            padding: 0 16px 14px;
        }

        .result-card-actions {
            display: flex;
            gap: 8px;
            padding: 0 16px 14px;
            border-top: 1px solid var(--border);
            padding-top: 12px;
            margin-top: 4px;
        }

        .result-action-btn {
            flex: 1;
            height: 40px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 13px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            transition: all var(--transition-fast);
        }
        .result-action-btn:hover { background: var(--bg-elevated); }
        .result-action-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .result-action-btn.playing {
            background: var(--accent);
            color: white;
        }

        .result-action-btn.loading {
            background: var(--bg-elevated);
            color: var(--text-secondary);
        }

        .tafseer-section {
            padding: 12px 16px 16px;
            border-top: 1px solid var(--border);
        }

        .tafseer-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .tafseer-tab-btn {
            flex: 1;
            height: 36px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 13px;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            transition: all var(--transition-fast);
            cursor: pointer;
        }

        .tafseer-tab-btn:hover {
            background: var(--bg-elevated);
            color: var(--text-primary);
        }

        .tafseer-tab-btn.active {
            background: var(--accent);
            color: white;
        }

        .tafseer-content {
            direction: rtl;
            text-align: justify;
            font-size: 16px;
            line-height: 1.8;
            color: var(--text-secondary);
            max-height: 250px;
            overflow-y: auto;
            background: var(--bg-tertiary);
            padding: 12px 16px;
            border-radius: 8px;
        }
        
        .tafseer-content .spinner {
            margin: 30px auto;
            width: 28px;
            height: 28px;
            border-width: 3px;
        }

        .highlight {
            background: var(--highlight-bg);
            color: var(--highlight-text);
            padding: 0 3px;
            border-radius: 4px;
        }

        .sticky-player {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
            padding: 12px 16px;
            padding-bottom: calc(12px + var(--safe-bottom));
            transform: translateY(100%);
            transition: transform var(--transition-slow);
            z-index: 100;
        }

        .sticky-player.visible {
            transform: translateY(0);
        }

        .player-content {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .player-info {
            flex: 1;
            min-width: 0;
        }

        .player-title {
            font-weight: 600;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .player-subtitle {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .player-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .player-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
        }

        .player-btn-main {
            background: var(--accent);
            color: white;
        }
        .player-btn-main:hover { background: var(--accent-hover); }

        .player-btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }
        .player-btn-secondary:hover { background: var(--bg-elevated); }

        .player-progress-container {
            margin-top: 10px;
        }

        .player-progress {
            width: 100%;
            height: 4px;
            -webkit-appearance: none;
            appearance: none;
            background: var(--bg-tertiary);
            border-radius: 2px;
            outline: none;
        }

        .player-progress::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
        }

        .player-progress::-moz-range-thumb {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
            border: none;
        }

        .player-time {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: var(--text-tertiary);
            margin-top: 4px;
        }

        .toast-container {
            position: fixed;
            bottom: calc(20px + var(--safe-bottom));
            left: 16px;
            right: 16px;
            z-index: 300;
            display: flex;
            flex-direction: column;
            gap: 8px;
            pointer-events: none;
        }

        .toast {
            background: var(--bg-elevated);
            padding: 14px 18px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            pointer-events: auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            animation: toastIn 0.3s ease;
        }

        @keyframes toastIn {
            from { opacity: 0; transform: translateY(20px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .toast-success { border-left: 4px solid var(--success); }
        .toast-error { border-left: 4px solid var(--danger); }
        .toast-warning { border-left: 4px solid var(--warning); }
        .toast-info { border-left: 4px solid var(--accent); }

        .toast-message { flex: 1; font-size: 14px; }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 32px;
            text-align: center;
        }

        .empty-state-icon {
            width: 80px;
            height: 80px;
            color: var(--text-tertiary);
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .empty-state-text {
            color: var(--text-secondary);
            font-size: 14px;
            max-width: 280px;
            line-height: 1.5;
        }

        .tab-bar {
            display: flex;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
            z-index: 40;
        }
        .tab-btn {
            flex: 1;
            padding: 14px;
            font-size: 15px;
            font-weight: 600;
            color: var(--text-secondary);
            border-bottom: 3px solid transparent;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .tab-btn.active {
            color: var(--text-primary);
            border-bottom-color: var(--accent);
        }
        .tab-content {
            flex: 1;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }
        .tab-content.active {
            display: flex;
        }
        #readingContent {
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
            flex: 1;
        }
        #pageContainer {
            direction: rtl;
            font-family: 'Amiri', serif;
            font-size: 20px;
            line-height: 2.2;
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 24px;
            margin: 16px;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            text-align: justify;
        }
        .page-surah-header {
            font-size: 26px;
            font-weight: 700;
            text-align: center;
            margin: 32px 0 24px;
            padding: 10px;
            border-top: 2px solid var(--accent);
            border-bottom: 2px solid var(--accent);
            background: var(--bg-tertiary);
            border-radius: 8px;
        }
        .page-ayah {
            display: inline;
        }
        .page-ayah-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 15px;
            font-weight: normal;
            color: var(--accent);
            margin: 0 4px;
        }
        .bismillah {
            text-align: center;
            font-size: 22px;
            margin-bottom: 24px;
        }
        .page-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border-top: 1px solid var(--border);
            background: var(--bg-secondary);
            flex-shrink: 0;
            padding-bottom: calc(12px + var(--safe-bottom));
            gap: 8px; /* Add gap for spacing */
        }
        #pageNumberDisplay {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            flex-grow: 1; /* Allow page number to take available space */
            text-align: center;
        }
        .page-nav-btn {
            padding: 10px 15px; /* Reduced padding */
            font-size: 14px;
            flex-shrink: 0;
            white-space: nowrap;
        }
        #recitePageBtn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .reading-nav {
            display: flex;
            gap: 12px;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            flex-wrap: wrap;
            align-items: center;
        }
        .reading-nav-select, .reading-nav-input {
            height: 40px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            padding: 0 10px;
            font-size: 14px;
        }
        .reading-nav-select {
            flex: 1;
            min-width: 120px;
        }

        @media (min-width: 640px) {
            .results-list {
                padding: 16px;
                max-width: 700px;
                margin: 0 auto;
            }

            .result-card {
                margin-bottom: 16px;
            }

            .result-card-text {
                font-size: 24px;
            }

            .search-section {
                max-width: 700px;
                margin: 0 auto;
                border-radius: 0 0 16px 16px;
            }
             #pageContainer {
                margin-top: 24px;
                margin-bottom: 24px;
            }
        }

        @supports (-webkit-touch-callout: none) {
            .search-input {
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
        <symbol id="icon-search" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></symbol>
        <symbol id="icon-x" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></symbol>
        <symbol id="icon-sun" viewBox="0 0 24 24"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></symbol>
        <symbol id="icon-moon" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></symbol>
        <symbol id="icon-play" viewBox="0 0 24 24"><polygon points="5 3 19 12 5 21 5 3"/></symbol>
        <symbol id="icon-pause" viewBox="0 0 24 24"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></symbol>
        <symbol id="icon-copy" viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></symbol>
        <symbol id="icon-check" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></symbol>
        <symbol id="icon-book" viewBox="0 0 24 24"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></symbol>
        <symbol id="icon-volume-2" viewBox="0 0 24 24"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/></symbol>
        <symbol id="icon-loader" viewBox="0 0 24 24"><line x1="12" y1="2" x2="12" y2="6"/><line x1="12" y1="18" x2="12" y2="22"/><line x1="4.93" y1="4.93" x2="7.76" y2="7.76"/><line x1="16.24" y1="16.24" x2="19.07" y2="19.07"/><line x1="2" y1="12" x2="6" y2="12"/><line x1="18" y1="12" x2="22" y2="12"/><line x1="4.93" y1="19.07" x2="7.76" y2="16.24"/><line x1="16.24" y1="7.76" x2="19.07" y2="4.93"/></symbol>
        <symbol id="icon-alert-circle" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></symbol>
        <symbol id="icon-zap" viewBox="0 0 24 24"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></symbol>
    </svg>

    <div id="app">
        <header class="header">
            <div style="width: 40px;"></div>
            <div class="header-title">
                Quran Search
                <div class="header-subtitle">البحث في القرآن الكريم</div>
            </div>
            <button class="header-btn" id="themeToggle" aria-label="Toggle theme">
                <svg class="icon" id="themeIcon"><use href="#icon-moon"/></svg>
            </button>
        </header>

        <div class="tab-bar">
            <button class="tab-btn" data-tab="search">
                <svg class="icon icon-sm"><use href="#icon-search"/></svg>
                <span>بحث</span>
            </button>
            <button class="tab-btn active" data-tab="reading">
                <svg class="icon icon-sm"><use href="#icon-book"/></svg>
                <span>قراءة</span>
            </button>
        </div>

        <div id="searchTab" class="tab-content">
            <div class="search-section">
                <div class="search-bar">
                    <svg class="icon"><use href="#icon-search"/></svg>
                    <input 
                        type="text" 
                        id="searchInput" 
                        class="search-input" 
                        placeholder="اكتب الكلمة التي تبحث عنها..."
                        autocomplete="off"
                        disabled
                    >
                    <button class="search-clear" id="clearButton" hidden aria-label="Clear search">
                        <svg class="icon-sm"><use href="#icon-x"/></svg>
                    </button>
                </div>
                <div class="search-controls">
                    <button class="search-btn search-btn-secondary" id="autoButton">
                        <svg class="icon-sm"><use href="#icon-zap"/></svg>
                        تلقائي
                    </button>
                    <button class="search-btn search-btn-primary" id="searchButton" disabled>
                        <svg class="icon-sm"><use href="#icon-search"/></svg>
                        بحث
                    </button>
                </div>
            </div>

            <div class="results-header" id="resultsHeader" hidden>
                <div class="results-count" id="resultsCount"></div>
                <button class="copy-all-btn" id="copyAllButton">
                    <svg class="icon-sm"><use href="#icon-copy"/></svg>
                    نسخ الكل
                </button>
            </div>

            <main class="main-content" id="mainContent">
                <div class="status-message" id="loadingStatus">
                    <div class="spinner"></div>
                    <div class="status-title">جاري التحميل...</div>
                    <div class="status-text">يتم تحميل بيانات القرآن الكريم</div>
                </div>

                <div class="empty-state" id="readyStatus" hidden>
                    <svg class="empty-state-icon"><use href="#icon-book"/></svg>
                    <div class="empty-state-title">ابدأ البحث</div>
                    <div class="empty-state-text">اكتب كلمة أو عبارة للبحث عنها في القرآن الكريم</div>
                </div>

                <div class="status-message" id="noResultsStatus" hidden>
                    <svg class="status-icon"><use href="#icon-alert-circle"/></svg>
                    <div class="status-title">لا توجد نتائج</div>
                    <div class="status-text" id="noResultsText"></div>
                </div>

                <div class="status-message" id="errorStatus" hidden>
                    <svg class="status-icon"><use href="#icon-alert-circle"/></svg>
                    <div class="status-title">حدث خطأ</div>
                    <div class="status-text">فشل تحميل البيانات. يرجى المحاولة مرة أخرى.</div>
                </div>

                <div class="results-list" id="resultsList" hidden></div>
            </main>
        </div>

        <div id="readingTab" class="tab-content active">
                        <div class="reading-nav">
                            <select id="pageSelect" class="reading-nav-select" aria-label="Go to page"></select>
                            <select id="surahSelect" class="reading-nav-select" aria-label="Go to Surah"></select>
                        </div>
            <main class="main-content" id="readingContent">
                <div id="pageContainer"></div>
            </main>
            <div class="page-navigation">
                <button id="prevPageBtn" class="search-btn search-btn-secondary page-nav-btn">‹ السابق</button>
                <button id="recitePageBtn" class="search-btn search-btn-secondary page-nav-btn" disabled>
                    <svg class="icon-sm"><use href="#icon-volume-2"/></svg> تلاوة
                </button>
                <div id="pageNumberDisplay">Page 1</div>
                <button id="nextPageBtn" class="search-btn search-btn-secondary page-nav-btn">التالي ›</button>
            </div>
        </div>
    </div>

    <div class="sticky-player" id="stickyPlayer">
        <div class="player-content">
            <div class="player-info">
                <div class="player-title" id="playerTitle">--</div>
                <div class="player-subtitle" id="playerSubtitle">--</div>
            </div>
            <div class="player-controls">
                <button class="player-btn player-btn-main" id="playerPlayPause" aria-label="Play/Pause">
                    <svg class="icon" id="playerPlayIcon"><use href="#icon-play"/></svg>
                </button>
                <button class="player-btn player-btn-secondary" id="playerClose" aria-label="Close player">
                    <svg class="icon-sm"><use href="#icon-x"/></svg>
                </button>
            </div>
        </div>
        <div class="player-progress-container">
            <input type="range" class="player-progress" id="playerProgress" value="0" min="0" max="100">
            <div class="player-time">
                <span id="playerCurrentTime">0:00</span>
                <span id="playerDuration">0:00</span>
            </div>
        </div>
    </div>

    <div class="toast-container" id="toastContainer"></div>

    <script>
        (function() {
            'use strict';

            // DOM Elements
            const searchInput = document.getElementById('searchInput');
            const clearButton = document.getElementById('clearButton');
            const autoButton = document.getElementById('autoButton');
            const searchButton = document.getElementById('searchButton');
            const resultsHeader = document.getElementById('resultsHeader');
            const resultsCount = document.getElementById('resultsCount');
            const copyAllButton = document.getElementById('copyAllButton');
            const resultsList = document.getElementById('resultsList');
            const mainContent = document.getElementById('mainContent');
            const loadingStatus = document.getElementById('loadingStatus');
            const readyStatus = document.getElementById('readyStatus');
            const noResultsStatus = document.getElementById('noResultsStatus');
            const noResultsText = document.getElementById('noResultsText');
            const errorStatus = document.getElementById('errorStatus');
            const themeToggle = document.getElementById('themeToggle');
            const themeIcon = document.getElementById('themeIcon');
            const stickyPlayer = document.getElementById('stickyPlayer');
            const playerTitle = document.getElementById('playerTitle');
            const playerSubtitle = document.getElementById('playerSubtitle');
            const playerPlayPause = document.getElementById('playerPlayPause');
            const playerPlayIcon = document.getElementById('playerPlayIcon');
            const playerProgress = document.getElementById('playerProgress');
            const playerCurrentTime = document.getElementById('playerCurrentTime');
            const playerDuration = document.getElementById('playerDuration');
            const playerClose = document.getElementById('playerClose');
            const toastContainer = document.getElementById('toastContainer');
            
            // New Tab elements
            const searchTab = document.getElementById('searchTab');
            const readingTab = document.getElementById('readingTab');
            const tabBar = document.querySelector('.tab-bar');

            // New Reading View elements
            const readingContent = document.getElementById('readingContent');
            const pageContainer = document.getElementById('pageContainer');
            const prevPageBtn = document.getElementById('prevPageBtn');
            const nextPageBtn = document.getElementById('nextPageBtn');
            const pageNumberDisplay = document.getElementById('pageNumberDisplay');
            const pageSelect = document.getElementById('pageSelect');
            const surahSelect = document.getElementById('surahSelect');
            const recitePageBtn = document.getElementById('recitePageBtn');


            // State
            let quranData = null;
            let surahsData = null;
            let searchTimeout = null;
            let isAutoSearchOn = false;
            let currentAudio = null;
            let currentPlayingButton = null;
            let isLightMode = true; // Default to light mode
            let currentPage = 1;
            let totalPages = 604; // Default, will be updated
            let currentPageAyahs = []; // Stores ayahs for the current page
            let currentPlayingPageAudio = []; // Array of Audio objects for page recitation
            let currentPlayingPageAyahIndex = -1;
            let isPageReciting = false;

            // Utility: Format time
            function formatTime(seconds) {
                if (isNaN(seconds)) return '0:00';
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            }

            // Toast notification
            function showToast(message, type = 'info', duration = 3000) {
                const toast = document.createElement('div');
                toast.className = `toast toast-${type}`;
                toast.innerHTML = `<span class="toast-message">${message}</span>`;
                toastContainer.appendChild(toast);
                
                setTimeout(() => {
                    toast.style.opacity = '0';
                    toast.style.transform = 'translateY(20px)';
                    setTimeout(() => toast.remove(), 300);
                }, duration);
            }

            // Normalize Arabic text for searching
            function normalizeArabic(text) {
                // Normalize Alef variations
                let normalized = text.replace(/[أإآٱٰ]/g, 'ا');
                // Normalize Ta Marbuta to Ha
                normalized = normalized.replace(/ة/g, 'ه');
                // Normalize Alef Maqsura to Ya
                normalized = normalized.replace(/ى/g, 'ي');
                // Remove diacritics (tashkeel) and other marks
                const diacritics = /[\u0610-\u061A\u064B-\u065F\u0670\u06D6-\u06DC\u06DF-\u06E4\u06E7\u06E8\u06EA-\u06ED\u0640\u0621]/g;
                normalized = normalized.replace(diacritics, '');
                return normalized;
            }

            // Highlight matching text in original ayah
            function highlightMatch(originalText, query) {
                const normalizedText = normalizeArabic(originalText);
                const normalizedQuery = normalizeArabic(query);
                
                const matchIndex = normalizedText.indexOf(normalizedQuery);
                if (matchIndex === -1) return originalText;
                
                let originalIndex = 0;
                let normalizedIndex = 0;
                let startInOriginal = -1;
                let endInOriginal = -1;
                
                while (originalIndex < originalText.length && normalizedIndex <= matchIndex + normalizedQuery.length) {
                    const originalChar = originalText[originalIndex];
                    const normalizedChar = normalizeArabic(originalChar);
                    
                    if (normalizedIndex === matchIndex && startInOriginal === -1) {
                        startInOriginal = originalIndex;
                    }
                    
                    if (normalizedChar.length > 0) {
                        normalizedIndex += normalizedChar.length;
                    }
                    
                    if (normalizedIndex >= matchIndex + normalizedQuery.length && endInOriginal === -1) {
                        endInOriginal = originalIndex + 1;
                        break;
                    }
                    
                    originalIndex++;
                }
                
                while (endInOriginal < originalText.length) {
                    const char = originalText[endInOriginal];
                    const normalizedChar = normalizeArabic(char);
                    if (normalizedChar.length === 0) {
                        endInOriginal++;
                    } else {
                        break;
                    }
                }
                
                if (startInOriginal === -1 || endInOriginal === -1) return originalText;
                
                const before = originalText.substring(0, startInOriginal);
                const match = originalText.substring(startInOriginal, endInOriginal);
                const after = originalText.substring(endInOriginal);
                
                return `${before}<span class="highlight">${match}</span>${after}`;
            }

            // Show/hide status views
            function showStatus(status) {
                loadingStatus.hidden = status !== 'loading';
                readyStatus.hidden = status !== 'ready';
                noResultsStatus.hidden = status !== 'no-results';
                errorStatus.hidden = status !== 'error';
                resultsList.hidden = status !== 'results';
                resultsHeader.hidden = status !== 'results';
            }

            // Theme toggle
            function updateTheme() {
                if (isLightMode) {
                    document.body.classList.add('light-mode');
                    themeIcon.innerHTML = '<use href="#icon-sun"/>';
                } else {
                    document.body.classList.remove('light-mode');
                    themeIcon.innerHTML = '<use href="#icon-moon"/>';
                }
            }

            themeToggle.addEventListener('click', () => {
                isLightMode = !isLightMode;
                localStorage.setItem('theme', isLightMode ? 'light' : 'dark');
                updateTheme();
            });

            // Load saved theme
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) { // If a theme is saved
                isLightMode = (savedTheme === 'light');
            }
            updateTheme(); // Update theme on initial load

            // Clear search
            function clearSearch() {
                searchInput.value = '';
                clearButton.hidden = true;
                showStatus('ready');
            }

            // Update auto button state
            function updateAutoButton() {
                if (isAutoSearchOn) {
                    autoButton.classList.add('active');
                    autoButton.innerHTML = '<svg class="icon-sm"><use href="#icon-zap"/></svg> تلقائي ✓';
                    searchButton.disabled = true;
                } else {
                    autoButton.classList.remove('active');
                    autoButton.innerHTML = '<svg class="icon-sm"><use href="#icon-zap"/></svg> تلقائي';
                    searchButton.disabled = false;
                }
            }

            // Perform search
            function performSearch(query) {
                if (!quranData || !query.trim()) return;

                const normalizedQuery = normalizeArabic(query.trim());
                
                if (normalizedQuery.length < 2) {
                    showToast('الرجاء إدخال حرفين على الأقل', 'warning');
                    return;
                }

                const searchResults = [];

                quranData.data.surahs.forEach(surah => {
                    surah.ayahs.forEach(ayah => {
                        const normalizedText = normalizeArabic(ayah.text);
                        if (normalizedText.includes(normalizedQuery)) {
                            searchResults.push({
                                surahNumber: surah.number,
                                surahName: surah.name,
                                surahEnglishName: surah.englishName,
                                ayahNumber: ayah.number,
                                ayahNumberInSurah: ayah.numberInSurah,
                                ayahText: ayah.text
                            });
                        }
                    });
                });

                renderResults(searchResults, query.trim());
            }

            // Render results
            function renderResults(results, query) {
                if (results.length === 0) {
                    noResultsText.textContent = `لم يتم العثور على نتائج لـ "${query}"`;
                    showStatus('no-results');
                    return;
                }

                copyAllButton.disabled = false;
                resultsCount.innerHTML = `<strong>${results.length}</strong> نتيجة`;
                
                resultsList.innerHTML = results.map((result, index) => {
                    const highlightedText = highlightMatch(result.ayahText, query);
                    const surah = quranData.data.surahs.find(s => s.number === result.surahNumber);
                    const isFirstAyah = result.ayahNumberInSurah === 1;
                    const isLastAyah = surah ? result.ayahNumberInSurah === surah.ayahs.length : false;

                    return `
                        <div class="result-card">
                            <div class="result-card-header">
                                <div class="result-card-info">
                                    <div class="result-card-title">
                                        <span class="result-card-number">${index + 1}</span>
                                        ${result.surahEnglishName} - ${result.surahName}
                                    </div>
                                    <div class="result-card-subtitle">
                                        سورة ${result.surahNumber} • آية ${result.ayahNumberInSurah}
                                    </div>
                                </div>
                                <div class="result-card-badge">آية ${result.ayahNumber}</div>
                            </div>
                            <p class="result-card-text">${highlightedText}</p>
                            <div class="result-card-actions">
                                <button 
                                    class="result-action-btn prev-btn" 
                                    data-surah="${result.surahNumber}" 
                                    data-ayah="${result.ayahNumberInSurah}"
                                    ${isFirstAyah ? 'disabled' : ''}
                                >
                                    السابق
                                </button>
                                <button 
                                    class="result-action-btn recite-btn" 
                                    data-surah="${result.surahNumber}" 
                                    data-ayah="${result.ayahNumberInSurah}"
                                    data-surah-name="${result.surahName}"
                                >
                                    <svg class="icon-sm"><use href="#icon-volume-2"/></svg>
                                    تلاوة
                                </button>
                                <button 
                                    class="result-action-btn next-btn" 
                                    data-surah="${result.surahNumber}" 
                                    data-ayah="${result.ayahNumberInSurah}"
                                    ${isLastAyah ? 'disabled' : ''}
                                >
                                    التالي
                                </button>
                            </div>
                            <div class="tafseer-section">
                                <div class="tafseer-tabs">
                                    <button class="tafseer-tab-btn" data-tafseer-id="8">الطبري</button>
                                    <button class="tafseer-tab-btn" data-tafseer-id="4">ابن كثير</button>
                                    <button class="tafseer-tab-btn" data-tafseer-id="6">البغوي</button>
                                    <button class="tafseer-tab-btn" data-tafseer-id="7">القرطبي</button>
                                </div>
                                <div class="tafseer-content" hidden>
                                    <div class="tafseer-text"></div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                showStatus('results');
            }
  
            async function fetchTafseer(id, surah, ayah, targetElement) {
    targetElement.innerHTML = '<div class="spinner"></div>';
    try {
        const proxyUrl ="https://old-band-312d.yabaggi.workers.dev/?quest=";
        
         <!--"https://corsproxy.io/?";-->
        const apiUrl = `http://api.quran-tafseer.com/tafseer/${id}/${surah}/${ayah}`;
        const response = await fetch(proxyUrl + encodeURIComponent(apiUrl));
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();
        targetElement.innerHTML = data.text;
    } catch (error) {
        targetElement.innerHTML = 'فشل تحميل التفسير. يرجى المحاولة مرة أخرى.';
        console.error('Failed to fetch tafseer:', error);
    }
}
            
            
            function updateAyah(cardElement, surahNumber, ayahNumberInSurah, direction) {
                if (!quranData) return;

                const surah = quranData.data.surahs.find(s => s.number === surahNumber);
                if (!surah) return;

                const currentAyahIndex = surah.ayahs.findIndex(a => a.numberInSurah === ayahNumberInSurah);
                if (currentAyahIndex === -1) return;
                
                let newAyahIndex;
                if (direction === 'next') {
                    newAyahIndex = currentAyahIndex + 1;
                } else { // prev
                    newAyahIndex = currentAyahIndex - 1;
                }

                if (newAyahIndex < 0 || newAyahIndex >= surah.ayahs.length) {
                    showToast('لا يوجد المزيد من الآيات في هذه السورة', 'warning');
                    return;
                }
                
                const newAyah = surah.ayahs[newAyahIndex];

                copyAllButton.disabled = true;

                const cardSubtitle = cardElement.querySelector('.result-card-subtitle');
                cardSubtitle.textContent = `سورة ${surah.number} • آية ${newAyah.numberInSurah}`;
                
                const cardBadge = cardElement.querySelector('.result-card-badge');
                cardBadge.textContent = `آية ${newAyah.number}`;

                const cardText = cardElement.querySelector('.result-card-text');
                cardText.innerHTML = newAyah.text;

                const prevBtn = cardElement.querySelector('.prev-btn');
                const nextBtn = cardElement.querySelector('.next-btn');
                const reciteBtn = cardElement.querySelector('.recite-btn');

                prevBtn.dataset.ayah = newAyah.numberInSurah;
                nextBtn.dataset.ayah = newAyah.numberInSurah;
                reciteBtn.dataset.ayah = newAyah.numberInSurah;

                prevBtn.disabled = (newAyahIndex === 0);
                nextBtn.disabled = (newAyahIndex === surah.ayahs.length - 1);
                
                // Reset tafseer section
                const tafseerContent = cardElement.querySelector('.tafseer-content');
                if (tafseerContent) {
                    tafseerContent.hidden = true;
                    tafseerContent.querySelector('.tafseer-text').innerHTML = '';
                }
                cardElement.querySelectorAll('.tafseer-tab-btn').forEach(btn => btn.classList.remove('active'));


                if (reciteBtn.classList.contains('playing') || reciteBtn.classList.contains('loading')) {
                    if (currentAudio) {
                        currentAudio.pause();
                        currentAudio = null;
                    }
                    if (currentPlayingButton) {
                        currentPlayingButton.classList.remove('playing', 'loading');
                        currentPlayingButton.innerHTML = '<svg class="icon-sm"><use href="#icon-volume-2"/></svg> تلاوة';
                        currentPlayingButton = null;
                    }
                    stickyPlayer.classList.remove('visible');
                }
            }

            // Page Recitation Logic
            function stopPageRecitation() {
                if (currentAudio) {
                    currentAudio.pause();
                    currentAudio = null;
                }
                isPageReciting = false;
                currentPlayingPageAyahIndex = -1;
                currentPlayingPageAudio = [];
                recitePageBtn.classList.remove('playing', 'loading');
                recitePageBtn.innerHTML = '<svg class="icon-sm"><use href="#icon-volume-2"/></svg> تلاوة';
                stickyPlayer.classList.remove('visible');
                // Remove highlight from all ayahs
                document.querySelectorAll('.page-ayah.highlight-playing').forEach(el => {
                    el.classList.remove('highlight-playing');
                });
            }

            async function playNextAyahInPage() {
                if (currentPlayingPageAyahIndex >= currentPageAyahs.length - 1) {
                    // End of page recitation
                    stopPageRecitation();
                    return;
                }

                currentPlayingPageAyahIndex++;
                const ayahToPlay = currentPageAyahs[currentPlayingPageAyahIndex];

                // Highlight current ayah
                document.querySelectorAll('.page-ayah').forEach(el => {
                    const surah = parseInt(el.dataset.surah);
                    const ayah = parseInt(el.dataset.ayah);
                    if (surah === ayahToPlay.surahNumber && ayah === ayahToPlay.numberInSurah) {
                        el.classList.add('highlight-playing');
                        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    } else {
                        el.classList.remove('highlight-playing');
                    }
                });

                // Clear previous audio
                if (currentAudio) {
                    currentAudio.pause();
                    currentAudio = null;
                }

                recitePageBtn.classList.add('loading');
                recitePageBtn.innerHTML = '<svg class="icon-sm"><use href="#icon-loader"/></svg> جاري التحميل...';

                const apiUrl = `https://quranapi.pages.dev/api/${ayahToPlay.surahNumber}/${ayahToPlay.numberInSurah}.json`;

                try {
                    const response = await fetch(apiUrl);
                    if (!response.ok) throw new Error('Network error');
                    const data = await response.json();

                    const misharyAudio = Object.values(data.audio).find(
                        reciter => reciter.reciter === "Mishary Rashid Al Afasy"
                    );

                    if (!misharyAudio?.url) {
                        throw new Error('Audio not found for current ayah');
                    }

                    currentAudio = new Audio(misharyAudio.url);
                    currentAudio.addEventListener('loadedmetadata', () => {
                        playerDuration.textContent = formatTime(currentAudio.duration);
                    });

                    currentAudio.addEventListener('timeupdate', () => {
                        const progress = (currentAudio.currentTime / currentAudio.duration) * 100;
                        playerProgress.value = progress;
                        playerCurrentTime.textContent = formatTime(currentAudio.currentTime);
                    });

                    currentAudio.addEventListener('ended', playNextAyahInPage); // Play next when current ends

                    currentAudio.play();
                    isPageReciting = true;
                    recitePageBtn.classList.remove('loading');
                    recitePageBtn.classList.add('playing');
                    recitePageBtn.innerHTML = '<svg class="icon-sm"><use href="#icon-pause"/></svg> إيقاف';

                    playerTitle.textContent = `${ayahToPlay.surahName}`;
                    playerSubtitle.textContent = `آية ${ayahToPlay.numberInSurah} (صفحة ${currentPage})`;
                    playerPlayIcon.innerHTML = '<use href="#icon-pause"/>';
                    stickyPlayer.classList.add('visible');

                } catch (error) {
                    console.error('Error playing ayah:', error);
                    recitePageBtn.classList.remove('loading');
                    recitePageBtn.innerHTML = '<svg class="icon-sm"><use href="#icon-alert-circle"/></svg> خطأ';
                    showToast('فشل تحميل تلاوة الآية', 'error');
                    // Try to play next ayah even if current one failed
                    playNextAyahInPage(); 
                }
            }

            recitePageBtn.addEventListener('click', () => {
                if (!isPageReciting) {
                    // Start new recitation
                    currentPlayingPageAyahIndex = -1; // Reset index to start from beginning
                    playNextAyahInPage();
                } else if (currentAudio) {
                    if (currentAudio.paused) {
                        currentAudio.play();
                        recitePageBtn.classList.add('playing');
                        recitePageBtn.innerHTML = '<svg class="icon-sm"><use href="#icon-pause"/></svg> إيقاف';
                        playerPlayIcon.innerHTML = '<use href="#icon-pause"/>';
                    } else {
                        currentAudio.pause();
                        recitePageBtn.classList.remove('playing');
                        recitePageBtn.innerHTML = '<svg class="icon-sm"><use href="#icon-volume-2"/></svg> تلاوة';
                        playerPlayIcon.innerHTML = '<use href="#icon-play"/>';
                    }
                }
            });

            // Play recitation
            function playRecitation(surah, ayah, surahName, button) {
                if (button.classList.contains('playing')) {
                    if (currentAudio) {
                        currentAudio.pause();
                    }
                    return;
                }

                if (currentAudio) {
                    currentAudio.pause();
                    if (currentPlayingButton) {
                        currentPlayingButton.classList.remove('playing', 'loading');
                        currentPlayingButton.innerHTML = '<svg class="icon-sm"><use href="#icon-volume-2"/></svg> تلاوة';
                    }
                }

                button.classList.add('loading');
                button.innerHTML = '<svg class="icon-sm"><use href="#icon-loader"/></svg> جاري التحميل...';
                currentPlayingButton = button;

                const apiUrl = `https://quranapi.pages.dev/api/${surah}/${ayah}.json`;

                fetch(apiUrl)
                    .then(response => {
                        if (!response.ok) throw new Error('Network error');
                        return response.json();
                    })
                    .then(data => {
                        const misharyAudio = Object.values(data.audio).find(
                            reciter => reciter.reciter === "Mishary Rashid Al Afasy"
                        );

                        if (!misharyAudio?.url) {
                            throw new Error('Audio not found');
                        }

                        currentAudio = new Audio(misharyAudio.url);
                        
                        currentAudio.addEventListener('loadedmetadata', () => {
                            playerDuration.textContent = formatTime(currentAudio.duration);
                        });

                        currentAudio.addEventListener('timeupdate', () => {
                            const progress = (currentAudio.currentTime / currentAudio.duration) * 100;
                            playerProgress.value = progress;
                            playerCurrentTime.textContent = formatTime(currentAudio.currentTime);
                        });

                        currentAudio.addEventListener('ended', () => {
                            button.classList.remove('playing');
                            button.innerHTML = '<svg class="icon-sm"><use href="#icon-volume-2"/></svg> تلاوة';
                            playerPlayIcon.innerHTML = '<use href="#icon-play"/>';
                            currentAudio = null;
                            currentPlayingButton = null;
                            stickyPlayer.classList.remove('visible');
                        });

                        currentAudio.play();

                        button.classList.remove('loading');
                        button.classList.add('playing');
                        button.innerHTML = '<svg class="icon-sm"><use href="#icon-pause"/></svg> إيقاف';

                        playerTitle.textContent = surahName;
                        playerSubtitle.textContent = `آية ${ayah}`;
                        playerPlayIcon.innerHTML = '<use href="#icon-pause"/>';
                        stickyPlayer.classList.add('visible');
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        button.classList.remove('loading');
                        button.innerHTML = '<svg class="icon-sm"><use href="#icon-alert-circle"/></svg> خطأ';
                        showToast('فشل تحميل التلاوة', 'error');
                        
                        setTimeout(() => {
                            button.innerHTML = '<svg class="icon-sm"><use href="#icon-volume-2"/></svg> تلاوة';
                        }, 2000);
                    });
            }

            // Copy all results
            function copyAllResults() {
                const cards = document.querySelectorAll('.result-card');
                if (cards.length === 0) return;

                const searchText = searchInput.value;
                let textToCopy = `وردت عبارة [${searchText}] في القرآن الكريم في [${cards.length}] موقع:\n\n`;

                cards.forEach((card, index) => {
                    const title = card.querySelector('.result-card-title').textContent.trim();
                    const subtitle = card.querySelector('.result-card-subtitle').textContent;
                    const ayahText = card.querySelector('.result-card-text').textContent;

                    textToCopy += `${index + 1}. ${title}\n${subtitle}\n${ayahText}\n\n`;
                });

                navigator.clipboard.writeText(textToCopy)
                    .then(() => {
                        showToast('تم نسخ النتائج', 'success');
                        copyAllButton.innerHTML = '<svg class="icon-sm"><use href="#icon-check"/></svg> تم النسخ';
                        setTimeout(() => {
                            copyAllButton.innerHTML = '<svg class="icon-sm"><use href="#icon-copy"/></svg> نسخ الكل';
                        }, 2000);
                    })
                    .catch(() => {
                        showToast('فشل النسخ', 'error');
                    });
            }

            // Tab Switching
            tabBar.addEventListener('click', e => {
                const tabBtn = e.target.closest('.tab-btn');
                if (!tabBtn) return;

                const tabName = tabBtn.dataset.tab;

                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                tabBtn.classList.add('active');

                searchTab.classList.toggle('active', tabName === 'search');
                readingTab.classList.toggle('active', tabName === 'reading');
            });

            // Reading View Logic
            function renderPage(pageNumber) {
                if (!quranData) return;

                // Stop any ongoing recitation
                stopPageRecitation();

                const ayahsOnPage = [];
                quranData.data.surahs.forEach(surah => {
                    surah.ayahs.forEach(ayah => {
                        if (ayah.page === pageNumber) {
                            ayahsOnPage.push({ ...ayah, surahName: surah.name, surahNumber: surah.number });
                        }
                    });
                });

                currentPageAyahs = ayahsOnPage; // Store ayahs for current page

                if (currentPageAyahs.length === 0) {
                    pageContainer.innerHTML = '<div>Page data not found.</div>';
                    recitePageBtn.disabled = true; // Disable if no ayahs
                    return;
                }

                let pageHTML = '';
                let currentSurahOnPage = -1;

                currentPageAyahs.forEach(ayah => {
                    if (ayah.surahNumber !== currentSurahOnPage) {
                        currentSurahOnPage = ayah.surahNumber;
                        pageHTML += `<div class="page-surah-header">${ayah.surahName}</div>`;
                        if (ayah.numberInSurah === 1 && ayah.surahNumber !== 1 && ayah.surahNumber !== 9) {
                            pageHTML += `<div class="bismillah">بِسْمِ اللَّهِ الرَّحْمَٰنِ الرَّحِيمِ</div>`;
                        }
                    }
                    pageHTML += `<span class="page-ayah" data-surah="${ayah.surahNumber}" data-ayah="${ayah.numberInSurah}">${ayah.text} <span class="page-ayah-number">﴿${ayah.numberInSurah.toLocaleString('ar-EG')}﴾</span></span> `;
                });

                pageContainer.innerHTML = pageHTML;
                pageNumberDisplay.textContent = `Page ${pageNumber}`;
                prevPageBtn.disabled = pageNumber <= 1;
                nextPageBtn.disabled = pageNumber >= totalPages;
                recitePageBtn.disabled = false; // Enable if ayahs present
                currentPage = pageNumber;
                
                if (pageSelect.value != pageNumber) {
                    pageSelect.value = pageNumber;
                }
                surahSelect.value = "";
            }

            prevPageBtn.addEventListener('click', () => {
                if (currentPage > 1) {
                    renderPage(currentPage - 1);
                    readingContent.scrollTop = 0;
                }
            });

            nextPageBtn.addEventListener('click', () => {
                if (currentPage < totalPages) {
                    renderPage(currentPage + 1);
                    readingContent.scrollTop = 0;
                }
            });

            // --- Reading View Navigation ---

            function populatePageSelect() {
                pageSelect.innerHTML = '';
                const defaultOption = document.createElement('option');
                defaultOption.value = "";
                defaultOption.textContent = "الصفحة";
                pageSelect.appendChild(defaultOption);

                for (let i = 1; i <= totalPages; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = `Page ${i}`;
                    pageSelect.appendChild(option);
                }
            }

            function populateSurahSelect() {
                if (!surahsData) return;
                surahSelect.innerHTML = '';
                const defaultOption = document.createElement('option');
                defaultOption.value = "";
                defaultOption.textContent = "السورة";
                surahSelect.appendChild(defaultOption);

                surahsData.forEach(surah => {
                    const option = document.createElement('option');
                    option.value = surah.number;
                    option.textContent = `${surah.number}. ${surah.englishName} (${surah.name})`;
                    surahSelect.appendChild(option);
                });
            }
            
            function handlePageSelect() {
                const pageNumber = parseInt(pageSelect.value);
                if (!isNaN(pageNumber)) {
                    renderPage(pageNumber);
                    readingContent.scrollTop = 0;
                    surahSelect.value = "";
                }
            }

            function handleSurahSelect() {
                const surahNumber = parseInt(surahSelect.value);
                if (isNaN(surahNumber)) {
                    return;
                };

                const surah = quranData.data.surahs.find(s => s.number === surahNumber);
                if (surah) {
                    const pageNumber = surah.ayahs[0].page;
                    renderPage(pageNumber);
                    readingContent.scrollTop = 0;
                    pageSelect.value = pageNumber;
                }
            }

                        // Event Listeners

                        pageSelect.addEventListener('change', handlePageSelect);

                        surahSelect.addEventListener('change', handleSurahSelect);

                        

                        searchInput.addEventListener('input', (e) => {
                const query = e.target.value;
                clearButton.hidden = !query;

                if (isAutoSearchOn) {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        if (query.trim()) {
                            performSearch(query.trim());
                        } else {
                            showStatus('ready');
                        }
                    }, 400);
                }
            });

            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && searchInput.value.trim()) {
                    performSearch(searchInput.value.trim());
                }
            });

            clearButton.addEventListener('click', clearSearch);

            autoButton.addEventListener('click', () => {
                isAutoSearchOn = !isAutoSearchOn;
                updateAutoButton();
                if (isAutoSearchOn && searchInput.value.trim()) {
                    performSearch(searchInput.value.trim());
                }
            });

            searchButton.addEventListener('click', () => {
                if (searchInput.value.trim()) {
                    performSearch(searchInput.value.trim());
                }
            });

            copyAllButton.addEventListener('click', copyAllResults);

            resultsList.addEventListener('click', (e) => {
                const reciteBtn = e.target.closest('.recite-btn');
                if (reciteBtn) {
                    const { surah, ayah, surahName } = reciteBtn.dataset;
                    playRecitation(surah, ayah, surahName, reciteBtn);
                    return;
                }

                const prevBtn = e.target.closest('.prev-btn');
                if (prevBtn) {
                    const { surah, ayah } = prevBtn.dataset;
                    const card = prevBtn.closest('.result-card');
                    updateAyah(card, parseInt(surah), parseInt(ayah), 'prev');
                    return;
                }

                const nextBtn = e.target.closest('.next-btn');
                if (nextBtn) {
                    const { surah, ayah } = nextBtn.dataset;
                    const card = nextBtn.closest('.result-card');
                    updateAyah(card, parseInt(surah), parseInt(ayah), 'next');
                    return;
                }

                const tafseerBtn = e.target.closest('.tafseer-tab-btn');
                if (tafseerBtn) {
                    const card = tafseerBtn.closest('.result-card');
                    
                    if (tafseerBtn.classList.contains('active')) {
                        tafseerBtn.classList.remove('active');
                        card.querySelector('.tafseer-content').hidden = true;
                        card.querySelector('.tafseer-text').innerHTML = '';
                        return;
                    }

                    const tafseerId = tafseerBtn.dataset.tafseerId;
                    const reciteBtnFromCard = card.querySelector('.recite-btn');
                    const surah = reciteBtnFromCard.dataset.surah;
                    const ayah = reciteBtnFromCard.dataset.ayah;

                    card.querySelectorAll('.tafseer-tab-btn').forEach(btn => btn.classList.remove('active'));
                    tafseerBtn.classList.add('active');
                    
                    const contentDiv = card.querySelector('.tafseer-content');
                    const textDiv = card.querySelector('.tafseer-text');
                    
                    contentDiv.hidden = false;
                    
                    fetchTafseer(tafseerId, surah, ayah, textDiv);
                }
            });

            // Player controls
            playerPlayPause.addEventListener('click', () => {
                if (!currentAudio) return;
                
                if (currentAudio.paused) {
                    currentAudio.play();
                    playerPlayIcon.innerHTML = '<use href="#icon-pause"/>';
                    // Update relevant button
                    if (isPageReciting) {
                        recitePageBtn.classList.add('playing');
                        recitePageBtn.innerHTML = '<svg class="icon-sm"><use href="#icon-pause"/></svg> إيقاف';
                    } else if (currentPlayingButton) {
                        currentPlayingButton.innerHTML = '<svg class="icon-sm"><use href="#icon-pause"/></svg> إيقاف';
                        currentPlayingButton.classList.add('playing');
                    }
                } else {
                    currentAudio.pause();
                    playerPlayIcon.innerHTML = '<use href="#icon-play"/>';
                    // Update relevant button
                    if (isPageReciting) {
                        recitePageBtn.classList.remove('playing');
                        recitePageBtn.innerHTML = '<svg class="icon-sm"><use href="#icon-volume-2"/></svg> تلاوة';
                    } else if (currentPlayingButton) {
                        currentPlayingButton.innerHTML = '<svg class="icon-sm"><use href="#icon-volume-2"/></svg> تلاوة';
                        currentPlayingButton.classList.remove('playing');
                    }
                }
            });

            playerProgress.addEventListener('input', () => {
                if (currentAudio) {
                    const seekTime = (playerProgress.value / 100) * currentAudio.duration;
                    currentAudio.currentTime = seekTime;
                }
            });

            playerClose.addEventListener('click', () => {
                if (isPageReciting) {
                    stopPageRecitation();
                } else {
                    if (currentAudio) {
                        currentAudio.pause();
                        currentAudio = null;
                    }
                    if (currentPlayingButton) {
                        currentPlayingButton.classList.remove('playing', 'loading');
                        currentPlayingButton.innerHTML = '<svg class="icon-sm"><use href="#icon-volume-2"/></svg> تلاوة';
                        currentPlayingButton = null;
                    }
                    stickyPlayer.classList.remove('visible');
                }
            });

            // Fetch surahs data
            fetch('surahs.json')
                .then(response => response.json())
                .then(data => {
                    surahsData = data;
                    populateSurahSelect();
                })
                .catch(error => {
                    console.error('Error loading surahs data:', error);
                });

            // Load Quran data
            fetch('quran.json')
                .then(response => {
                    if (!response.ok) throw new Error('Network error');
                    return response.json();
                })
                .then(data => {
                    quranData = data;
                    const lastSurah = quranData.data.surahs[quranData.data.surahs.length - 1];
                    const lastAyah = lastSurah.ayahs[lastSurah.ayahs.length - 1];
                    totalPages = lastAyah.page;
                    
                    searchInput.disabled = false;
                    searchButton.disabled = false;
                    showStatus('ready');
                    renderPage(1);
                    populatePageSelect();
                })
                .catch(error => {
                    console.error('Error loading Quran data:', error);
                    showStatus('error');
                });

            // Initialize
            updateAutoButton();
        })();
    </script>
</body>
</html>

